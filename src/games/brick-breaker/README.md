# Game: brick-breaker

## 概要
ブロックをボールで壊していくブロックくずしです。  
ステージ選択・ブロック種類（かたい/ぶんれつ）・コンティニュー・ステージエディタ（保存/共有）に対応しています。

## 操作方法
- **PC**: ゲーム画面（キャンバス）上でマウスをドラッグ/移動してバーを動かす
- **タッチ**: ゲーム画面上を指でドラッグしてバーを動かす

## ルール / 仕様
- **目的**: ボールを落とさずにブロックを全部こわす（ステージクリア）
- **スコア**:
  - ふつうブロック: +10
  - やわらかブロック: +10（こわすが反射しない）
  - かたいブロック（HPつき）: こわしたとき +35、当てたとき +2
  - ぶんれつブロック: +25（こわすと「合計Nこ」に分裂）
  - 💣 ばくはつ: +20（こわすと周り3×3もまとめて壊す）
  - 🙃 さかさ: +15（こわすとしばらく操作がさかさ）
  - 🔵 でかボール: +18（こわすと5秒でかボール）
  - ⬇️ 片方向壁: +8（上からは反射、下からは壊れて通れる）
  - 🧱 かべ: +0（壊れない。ステージクリア判定からも除外）
  - 🌀 ワープ: +0（基本は壊れない。ふれるとワープ）
- **LIFE**: 3（ボールが全部落ちると -1）
- **コンティニュー**:
  - LIFE が残っていれば、その状態（ブロック/スコア）から「つづける」ができます
  - LIFE が0でも「コンティニュー」で復活できます（CONTINUE回数が表示されます）
- **ステージクリア**: ブロックが全部なくなるとクリア。次のステージへ進むか、選択画面へ戻れます

## 演出（気持ちよさ）
- **効果音（SFX）**: ブロック種ごとに音色が変わります（WebAudioで生成、素材ファイル不要）。
  - 右上の **「音: ON/OFF」** で切り替えできます（設定は localStorage に保存）。
  - ブラウザ仕様で、**最初のタップ/クリック後に音が有効**になります。
- **パーティクル**: 破壊/ヒット時に破片や火花が出ます（ブロック種ごとに色・量・リング演出が変わります）。

## 画面 / UI
- **ステージ選択**: 最初にステージを選んでプレイへ（上部の「新しく作る」から作成もできます）
- **プレイ**: HUD（SCORE/LIFE/BALL/CONTINUE）、一時停止 / 最初から
- **ステージ編集**: ブロック種を選んでペイント配置、保存/読みこみ/ぜんぶ消す
- **ステージライブラリ（編集内）**: ロード / 削除 / 書き出し（JSON）/ インポート / ぜんぶエクスポート

## 実装メモ（設計）
- **エントリ**: `index.html`（`stage-select.html` にリダイレクト）
- **ページ**:
  - `stage-select.html`: ステージ選択
  - `play.html`: プレイ（スマホでゲーム画面を最大化）
  - `editor.html`: ステージ編集（スマホでも編集領域を広く）
- **メインロジック**:
  - `shared.js`: ステージ保存/読み込み（Supabase + localStorage）
  - `play.js`: プレイ処理
  - `editor.js`: エディタ処理
- **主要な状態(state)**:
  - プレイ: `playingStageName`, `bricks`, `balls`, `score`, `lives`, `continueCount`
  - エディタ: `currentStage`, `currentTool`
- **データ保存（ステージ）**:
  - **Supabase**: `brick_breaker_stages` テーブル（`name` ユニーク / `data` JSON）
  - **localStorage**: キャッシュ用 `ngames.brickBreaker.stages.v1`
  - ※ Supabaseテーブル作成は `supabase_setup_brick_breaker_stages.sql` を実行してください
- **スコア保存**: Supabase `scores` テーブル（`game_id = "brick-breaker"`）

### ステージデータ形式（JSON）
- `cols: 14`, `rows: 10`
- `grid`: 長さ `cols*rows` の配列
  - **互換**: 旧形式は「typeのみ（0..255）」でも読み込めます
  - **新形式**: `(param << 8) | type`
    - `type`: ブロック種類
    - `param`: 一部ブロックの追加パラメータ（例: かたいHP、分裂数）

#### type 一覧
- `0` = 空
- `1` = ふつう
- `2` = かたい（param = HP / 1..50、未指定は 3）
- `3` = ぶんれつ（param = 分裂後の合計ボール数 / 2..50、未指定は 5）
- `4` = やわらか（壊れるが反射しない）
- `5` = かべ（壊れない）
- `6` = 💣 ばくはつ（周り3×3を巻きこむ）
- `7` = 🌀 ワープ（基本は壊れない）
- `8` = 🙃 さかさ（しばらく操作がさかさ）
- `9` = 🔵 でかボール（5秒）
- `10` = ⬇️ 片方向壁（上からは反射、下からは壊れる）
- `11` = 🐌 のろのろ（当たるとスロー + ボール青っぽい、約5秒）
- `12` = ⚡ はやはや（当たると高速 + ボール赤っぽい、約5秒）
- `13` = 🩹 ベタベタ（当たるとボールがブロックにベチャッ→約5秒でぼとっと落下）
- `14` = 🌈 無敵モード（壊すとバーが虹色、約5秒タップでボール追加）
- `15` = ↔️ 横にポヨーン（param = 耐久 / 1..10、未指定は 2）

## ファイル構成
- `index.html`: ステージ選択へリダイレクト
- `stage-select.html`: ステージ選択（プレイ/編集へ）
- `play.html`: プレイ画面（フルスクリーン寄り）
- `editor.html`: ステージ編集画面（フルスクリーン寄り）
- `shared.js`: ステージ周りの共通ロジック
- `overlay.js`: 共通オーバーレイ
- `style.css`: ブロックくずし用の共通UIスタイル

## 既知の課題 / TODO
- ぶんれつが増えすぎないように最大数を制限している（調整余地あり）
- ブロックの当たり判定/反射はシンプル実装なので、角当たりの挙動は改善余地あり
